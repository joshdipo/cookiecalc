@page "/recipe-builder"
@rendermode InteractiveServer
@using cookiecalc.Measurement
@using Microsoft.AspNetCore.Components.Web

<PageTitle>Recipe Builder</PageTitle>

<div class="container">
    <h1>Cookie Recipe Builder</h1>
    <p class="text-muted">Create and manage your cookie recipe with organized ingredient categories.</p>

    <div class="row">
        <div class="col-md-8">
            <!-- Recipe Name -->
            <div class="mb-4">
                <label for="recipeName" class="form-label">Recipe Name</label>
                <input 
                    type="text" 
                    id="recipeName" 
                    class="form-control" 
                    @bind="recipe.Name"
                    placeholder="Enter recipe name">
            </div>

            <!-- Add Ingredient Section -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Add Ingredient</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">Component loaded. Selections: @selectionAttempts | newIngredient = "@newIngredient"</div>
                    @if (!string.IsNullOrEmpty(debugMessage))
                    {
                        <div class="alert alert-warning">@debugMessage</div>
                    }
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="ingredientSelect" class="form-label">Ingredient</label>
                            <select id="ingredientSelect" class="form-select" @onchange="OnIngredientSelected">
                                <option value="">-- Select Ingredient --</option>
                                @foreach (Ingredient ingredient in Enum.GetValues(typeof(Ingredient)))
                                {
                                    <option value="@ingredient.ToString()">@ingredient.GetDisplayName()</option>
                                }
                            </select>
                        </div>
                        <div class="col-md-2 mb-3">
                            <label for="amount" class="form-label">Amount</label>
                            <input 
                                type="number" 
                                id="amount" 
                                class="form-control" 
                                @bind="newAmount"
                                step="0.1"
                                min="0">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="unitSelect" class="form-label">Unit</label>
                            <select id="unitSelect" class="form-select" @bind="newUnitType">
                                <option value="metric-volume">Milliliters (ml)</option>
                                <option value="metric-weight">Grams (g)</option>
                                <option value="imperial-volume">Cups (cup)</option>
                                <option value="imperial-weight">Ounces (oz)</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-3 d-flex align-items-end">
                            <button 
                                class="btn btn-primary w-100" 
                                @onclick="AddIngredient"
                                disabled="@string.IsNullOrEmpty(newIngredient)">
                                Add
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- DEBUG OUTPUT -->
            @if (!string.IsNullOrEmpty(debugMessage))
            {
                <div class="alert alert-warning">
                    <strong>Debug:</strong> @debugMessage | newIngredient = "@newIngredient" | Button disabled = "@string.IsNullOrEmpty(newIngredient)"
                </div>
            }

            <!-- Ingredients by Category -->
            @if (recipe.Ingredients.Count > 0)
            {
                var ingredientsByCategory = recipe.GetIngredientsByCategory();
                
                @foreach (var category in ingredientsByCategory.Keys)
                {
                    var ingredientsInCategory = ingredientsByCategory[category];
                    if (ingredientsInCategory.Count > 0)
                    {
                        <div class="card mb-3">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="mb-0">@category.GetDisplayName()</h5>
                                    <small class="text-muted">Total: @recipe.GetCategoryTotal(category).ToString("F1") g</small>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-sm mb-0">
                                        <thead>
                                            <tr>
                                                <th>Ingredient</th>
                                                <th>Amount</th>
                                                <th>Unit</th>
                                                <th>Action</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var ingredient in ingredientsInCategory)
                                            {
                                                <tr>
                                                    <td>@ingredient.IngredientType.GetDisplayName()</td>
                                                    <td>@ingredient.Amount.ToString("F2")</td>
                                                    <td>@GetUnitDisplayName(ingredient.Unit)</td>
                                                    <td>
                                                        <button 
                                                            class="btn btn-sm btn-danger" 
                                                            @onclick="() => RemoveIngredient(ingredient)">
                                                            Remove
                                                        </button>
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    }
                }
            }
            else
            {
                <div class="alert alert-info">
                    No ingredients added yet. Start by selecting an ingredient above.
                </div>
            }
        </div>

        <!-- Summary Sidebar -->
        <div class="col-md-4">
            <div class="card sticky-top">
                <div class="card-header">
                    <h5 class="mb-0">Recipe Summary</h5>
                </div>
                <div class="card-body">
                    <h6 class="text-muted mb-3">Category Totals (grams)</h6>
                    @if (recipe.Ingredients.Count > 0)
                    {
                        <div class="list-group list-group-flush">
                            @foreach (var category in Enum.GetValues(typeof(IngredientCategory)).Cast<IngredientCategory>())
                            {
                                var total = recipe.GetCategoryTotal(category);
                                if (total > 0)
                                {
                                    <div class="list-group-item d-flex justify-content-between">
                                        <span>@category.GetDisplayName()</span>
                                        <strong>@total.ToString("F1") g</strong>
                                    </div>
                                }
                            }
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between">
                            <span>Total Weight</span>
                            <strong>@recipe.Ingredients.Sum(i => new Measurement(i.Amount, i.Unit, i.IngredientType).ConvertTo(MetricWeightUnit.Gram).Value).ToString("F1") g</strong>
                        </div>
                    }
                    else
                    {
                        <p class="text-muted small">Add ingredients to see summary.</p>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private Recipe recipe = new();
    private string? newIngredient;
    private double newAmount = 0;
    private string newUnitType = "metric-weight";
    private string debugMessage = ""; // Add this for debugging
    private int selectionAttempts = 0;

    private void OnIngredientSelected(ChangeEventArgs e)
    {
        selectionAttempts++;
        debugMessage = $"DEBUG: Event fired {selectionAttempts} times. Value = '{e.Value}'";
        Console.WriteLine(debugMessage);
        
        if (Enum.TryParse<Ingredient>(e.Value?.ToString(), out var ingredient))
        {
            newIngredient = ingredient.ToString();
            debugMessage += $" → Parsed as {ingredient}";
        }
        else
        {
            newIngredient = null;
            debugMessage += $" → FAILED to parse";
        }
        Console.WriteLine($"newIngredient is now: {newIngredient}");
    }

    private void AddIngredient()
    {
        if (string.IsNullOrEmpty(newIngredient) || newAmount <= 0)
        {
            return;
        }

        if (!Enum.TryParse<Ingredient>(newIngredient, out var ingredient))
        {
            return;
        }

        var unit = GetUnitFromType();
        var category = ingredient.GetCategory();

        var recipeIngredient = new RecipeIngredient(ingredient, category, newAmount, unit);
        recipe.AddIngredient(recipeIngredient);

        // Reset form
        newIngredient = null;
        newAmount = 0;
        newUnitType = "metric-weight";
    }

    private void RemoveIngredient(RecipeIngredient ingredient)
    {
        recipe.RemoveIngredient(ingredient);
    }

    private object GetUnitFromType()
    {
        return newUnitType switch
        {
            "metric-volume" => MetricVolumeUnit.Milliliter,
            "metric-weight" => MetricWeightUnit.Gram,
            "imperial-volume" => ImperialVolumeUnit.Cup,
            "imperial-weight" => ImperialWeightUnit.Ounce,
            _ => MetricWeightUnit.Gram
        };
    }

    private string GetUnitDisplayName(object unit)
    {
        return unit switch
        {
            MetricVolumeUnit.Milliliter => "ml",
            MetricVolumeUnit.Liter => "L",
            MetricWeightUnit.Gram => "g",
            MetricWeightUnit.Kilogram => "kg",
            ImperialVolumeUnit.Cup => "cup",
            ImperialVolumeUnit.Tablespoon => "tbsp",
            ImperialVolumeUnit.Teaspoon => "tsp",
            ImperialWeightUnit.Ounce => "oz",
            ImperialWeightUnit.Pound => "lb",
            _ => unit?.ToString() ?? "unknown"
        };
    }
}
